name: Build Windows .exe

on:
  push:
    branches: [main]
  workflow_dispatch:  # allows manual trigger from GitHub UI

jobs:
  build:
    name: Build for Windows
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      # Checkout with full git history (needed for Unity cache)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # Cache Unity Library folder to speed up subsequent builds
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: TejimolaBlossom/Library
          key: Library-TejimolaBlossom-StandaloneWindows64-${{ hashFiles('TejimolaBlossom/Assets/**', 'TejimolaBlossom/Packages/**', 'TejimolaBlossom/ProjectSettings/**') }}
          restore-keys: |
            Library-TejimolaBlossom-StandaloneWindows64-
            Library-TejimolaBlossom-

      # Build the Unity project
      - name: Build with Unity (GameCI)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: TejimolaBlossom
          unityVersion: 6000.3.8f1
          targetPlatform: StandaloneWindows64
          buildName: TejimolaBlossom
          buildsPath: build
          buildMethod: ""
          unityLicensingServer: ""

      # Upload build artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TejimolaBlossom-Windows-${{ github.sha }}
          path: build/StandaloneWindows64
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download Build
        uses: actions/download-artifact@v4
        with:
          name: TejimolaBlossom-Windows-${{ github.sha }}
          path: build

      # Zip the build for easy download
      - name: Zip Build
        run: |
          cd build
          zip -r ../TejimolaBlossom-Windows.zip .
          cd ..
          ls -lh TejimolaBlossom-Windows.zip

      # Create a GitHub Release with the .zip (contains the .exe)
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "Tejimola: The Blossom From Clay - Build ${{ github.run_number }}"
          body: |
            ## Windows Download

            1. Download `TejimolaBlossom-Windows.zip` below
            2. Extract the zip
            3. Run `TejimolaBlossom.exe`

            Built from commit: ${{ github.sha }}
          files: TejimolaBlossom-Windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
